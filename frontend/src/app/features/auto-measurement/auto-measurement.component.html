<div class="auto-measurement">
  <!-- SAVE DIRECTORY -->
  <div class="save-location-row">
    <label>Mentési hely</label>
    <div class="save-location-input-group">
      <input
        type="text"
        class="styled-input save-location-input"
        [(ngModel)]="saveLocation"
        [disabled]="measurementActive"
        placeholder="Válasszon mappát..."
        readonly
      />
      <button
        type="button"
        class="browse-button"
        (click)="selectSaveFolder()"
        [disabled]="measurementActive"
      >
        ...
      </button>
    </div>
  </div>

  <!-- MEASUREMENT NAME -->
  <div class="measurement-name-row">
    <label for="measurementName">Mérés neve</label>
    <input
      id="measurementName"
      type="text"
      class="styled-input measurement-name-input"
      [(ngModel)]="measurementName"
      [disabled]="measurementActive"
      placeholder="Adja meg a mérés nevét..."
    />
  </div>

  <!-- TOGGLE BUTTONS -->
  <div class="toggle-row">
    <button
      type="button"
      class="toggle-button"
      [class.active]="autofocus"
      (click)="autofocus = !autofocus"
      [disabled]="measurementActive"
    >
      <img src="assets/SVG/auto_focus.svg" alt="Autofocus" />
      <span class="toggle-label">Autofocus</span>
    </button>

    <button
      type="button"
      class="toggle-button"
      [class.active]="lampTop"
      (click)="lampTop = !lampTop"
      [disabled]="measurementActive"
    >
      <img src="assets/SVG/ringlight_off.svg" alt="Dome light" />
      <span class="toggle-label">Dóm fény</span>
    </button>

    <button
      type="button"
      class="toggle-button"
      [class.active]="lampSide"
      (click)="lampSide = !lampSide"
      [disabled]="measurementActive"
    >
      <img src="assets/SVG/barlight_off.svg" alt="Bar light" />
      <span class="toggle-label">Súrló  fény</span>
    </button>

    <button
      type="button"
      class="toggle-button"
      [class.active]="backgroundSubtraction"
      (click)="backgroundSubtraction = !backgroundSubtraction"
      [disabled]="measurementActive"
    >
      <img src="assets/SVG/SVG/bkgrndsub.svg" alt="Background subtraction" />
      <span class="toggle-label">Háttérlevonás</span>
    </button>
  </div>

  <!-- SELECTION HEADER: COUNT + CLEAR BUTTON -->
  <div class="selection-header">
    <div class="selection-count">
      Kijelölt tabletták száma:
      <span class="count">{{ selectedCount }}</span>
    </div>

    <button
      type="button"
      class="clear-button"
      (click)="clearSelection()"
      [disabled]="!hasSelection() || measurementActive"
    >
      Kijelölés törlése
    </button>
  </div>

  <!-- DOT GRID -->
  <div class="tablet-grid" (mouseleave)="onGridMouseLeave()" (click)="hideTabletContextMenu()">
    <div
      *ngFor="let id of tablets"
      class="tablet-dot"
      [class.selected]="isDotSelected(id)"
      [class.completed]="isDotCompleted(id)"
      [class.failed]="isDotFailed(id)"
      [class.in-progress]="isDotInProgress(id)"
      [class.pending]="getDotState(id) === 'pending' && measurementActive"
      (click)="onDotClick(id)"
      (contextmenu)="onTabletContextMenu($event, id)"
      (mouseenter)="onDotMouseEnter(id)"
      [title]="'Tabletta ' + id"
    >
      <span class="tablet-number">{{ getTabletLabel(id) }}</span>
    </div>
  </div>

  <!-- Tablet context menu -->
  @if (tabletContextMenuVisible) {
    <div class="context-menu tablet-context-menu" 
         [style.left.px]="tabletContextMenuX"
         [style.top.px]="tabletContextMenuY"
         (mouseleave)="hideTabletContextMenu()">
      <div class="context-menu-item" (click)="selectTablet()">
        <span>Kiválaszt</span>
      </div>
      <div class="context-menu-item" 
           [class.disabled]="!tabletHomed"
           [title]="tabletHomed ? '' : 'Mozgásplatform nincs homing-olva'"
           (click)="tabletHomed && moveToTablet()"
           (mousedown)="$event.preventDefault()"
           (mouseup)="$event.preventDefault()">
        <span>Mozgás ide</span>
      </div>
    </div>
  }

  <!-- START / STOP BUTTON FULL WIDTH -->
  <button
    class="start-button"
    [ngClass]="{ stop: measurementActive }"
    (click)="startMeasurement()"
    [disabled]="!canStart()"
  >
    {{ measurementActive ? 'Mérés leállítása' : 'Mérés indítása' }}
  </button>

  <!-- INFO MESSAGE (shown when button is enabled) -->
  <div class="status info" *ngIf="!measurementActive && getInfoMessage()">
    {{ getInfoMessage() }}
  </div>

  <!-- VALIDATION MESSAGE (shown when not measuring) -->
  <div class="status warning" *ngIf="!measurementActive && validationMessage">
    {{ validationMessage }}
  </div>

  <!-- STATUS MESSAGES -->
  <div class="status" *ngIf="measurementActive && !reconnecting && validationMessage">
    {{ validationMessage }}
  </div>
  <div class="status" *ngIf="measurementActive && !reconnecting && !validationMessage">
    Mérés folyamatban… ({{ currentTabletIndex }}/{{ selectedCount }})
  </div>
  <div class="status error" *ngIf="measurementActive && !reconnecting && errorMessage">
    {{ errorMessage }}
  </div>
  <div class="status warning" *ngIf="measurementActive && reconnecting && reconnectMessage">
    {{ reconnectMessage }}
  </div>
  <div class="status success" *ngIf="!measurementActive && successMessage">
    {{ successMessage }}
  </div>
  <div class="status error" *ngIf="!measurementActive && errorMessage">
    {{ errorMessage }}
  </div>
</div>
